<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Choco Milky IPA Library V2</title>
<style>
:root{
  --bg:#0d0d0f; --card:rgba(28,28,32,0.85); --accent:#0a84ff; --text:#f5f5f7;
  --subtle:#9ca3af; --radius:18px; --shadow:0 8px 24px rgba(0,0,0,0.4);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
body{margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh}
header{padding:28px 20px;text-align:center}
h1{margin:0;font-size:22px;font-weight:600}
#container{max-width:1100px;margin:0 auto;padding:12px 20px 40px}
#importRepo{width:100%;max-width:800px;margin:0 auto 18px;display:flex;gap:8px;justify-content:center}
#importRepo input{flex:1;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:var(--text);min-width:0}
#importRepo button{padding:12px 16px;border-radius:14px;background:var(--accent);color:#fff;border:0;cursor:pointer;font-weight:600}
#repos{display:flex;flex-direction:column;gap:12px;margin:18px auto;max-width:800px}
.repo-section-title{color:var(--subtle);font-weight:700;margin-top:8px;margin-bottom:6px}
.repo-card{display:flex;align-items:center;gap:12px;background:var(--card);padding:12px;border-radius:14px;box-shadow:var(--shadow);flex-wrap:wrap}
.repo-card img{width:48px;height:48px;border-radius:10px;object-fit:cover}
.repo-info{flex:1;min-width:180px}
.repo-name{font-weight:700}
.repo-desc{color:var(--subtle);font-size:13px;margin-top:4px}
.repo-actions{display:flex;gap:8px}
.repo-actions button{padding:8px 10px;border-radius:12px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
.repo-actions button.copy{background:#444}
.repo-actions button.delete{background:#ff3b30}
#searchBar{display:none;justify-content:center;margin:14px auto;max-width:600px}
#searchInput{flex:1;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:var(--text)}
#apps{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px;padding:18px;flex:1;max-width:1100px;margin:18px auto}
.card{background:var(--card);border-radius:16px;padding:16px;text-align:center;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center}
.icon img{width:72px;height:72px;border-radius:14px;object-fit:cover;margin-bottom:12px}
.title{font-weight:700;margin-bottom:6px}
.subtitle{color:var(--subtle);font-size:13px;margin-bottom:8px}
.version{font-size:12px;color:#aaa;margin-bottom:12px}
.download{display:inline-block;padding:10px 14px;border-radius:14px;background:var(--accent);color:#fff;text-decoration:none;font-weight:700}
#backBtn{display:none;margin:8px auto;background:#333;color:#fff;border:0;padding:10px 16px;border-radius:14px;cursor:pointer;font-weight:700}
#toast{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#fff;padding:10px 16px;border-radius:12px;display:none;z-index:9999}
.loading-line{color:#999;text-align:center;padding:14px}
footer{text-align:center;color:var(--subtle);padding:18px 0;margin-top:auto}
@media (max-width:640px){.repo-card{flex-direction:column;align-items:flex-start}.repo-actions{width:100%;justify-content:flex-end}}
</style>
</head>
<body>
<header><h1>Choco Milky IPA Library V2</h1></header>
<div id="container">
  <div id="importRepo">
    <input id="importInput" type="url" placeholder="Paste repo URL here (.json, .php, or domain)">
    <button id="importBtn">Import</button>
  </div>

  <div id="repos"></div>

  <button id="backBtn">← Back to Libraries</button>

  <div id="searchBar"><input id="searchInput" type="text" placeholder="Search apps…"></div>

  <div id="apps"></div>
</div>

<div id="toast"></div>
<footer>© 2025 Choco Milky IPA Library V2</footer>

<script>
const reposArea = document.getElementById('repos');
const appsArea = document.getElementById('apps');
const importRepoBox = document.getElementById('importRepo');
const importInput = document.getElementById('importInput');
const importBtn = document.getElementById('importBtn');
const backBtn = document.getElementById('backBtn');
const searchBar = document.getElementById('searchBar');
const searchInput = document.getElementById('searchInput');
const toast = document.getElementById('toast');

let currentApps = [];
let viewingRepoUrl = null;

function showToast(msg, ms = 1500) {
  toast.textContent = msg;
  toast.style.display = 'block';
  clearTimeout(toast._t);
  toast._t = setTimeout(() => (toast.style.display = 'none'), ms);
}

// =======================================================
// Load repos from backend
// =======================================================
async function loadRepos() {
  reposArea.innerHTML = `<div class="loading-line">Loading libraries…</div>`;

  try {
    const res = await fetch("/api/repos");
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      reposArea.innerHTML = `<div class="loading-line">No libraries loaded.</div>`;
      return;
    }

    let out = "";
    data.forEach(repo => {
      const r = repo.data;
      const first = (r.apps && r.apps[0]) || {};
      const icon = r.iconURL || first.iconURL || "";
      const name = r.name || first.name || "Unnamed Repo";
      const desc = r.description || first.subtitle || first.localizedDescription || "";

      out += `
        <div class="repo-card" data-url="${repo.url}">
          <img src="${icon}" alt="">
          <div class="repo-info">
            <div class="repo-name">${name}</div>
            <div class="repo-desc">${desc}</div>
          </div>
          <div class="repo-actions">
            <button class="openBtn" data-url="${repo.url}">Open</button>
            <button class="copyBtn" data-url="${repo.url}">Copy URL</button>
          </div>
        </div>
      `;
    });

    reposArea.innerHTML = out;
    attachRepoHandlers();

  } catch (err) {
    console.error(err);
    reposArea.innerHTML = `<div class="loading-line">Failed to load repos.</div>`;
  }
}

function attachRepoHandlers() {
  document.querySelectorAll(".openBtn").forEach(btn => {
    btn.onclick = () => openRepo(btn.dataset.url);
  });
  document.querySelectorAll(".copyBtn").forEach(btn => {
    btn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(btn.dataset.url);
        showToast("Copied URL");
      } catch {
        alert("Copy failed");
      }
    };
  });
}

async function openRepo(url) {
  viewingRepoUrl = url;
  window.scrollTo({ top: 0, behavior: "auto" });
  reposArea.style.display = "none";
  importRepoBox.style.display = "none";
  backBtn.style.display = "block";
  searchBar.style.display = "flex";
  appsArea.innerHTML = `<div class="loading-line">Loading apps…</div>`;

  try {
    const res = await fetch("/api/repos");
    const all = await res.json();
    const repo = all.find(r => r.url === url);
    if (!repo) throw new Error("Repo not found");
    const apps = repo.data.apps || [];
    currentApps = apps;
    renderApps(apps);
  } catch (e) {
    console.error(e);
    appsArea.innerHTML = `<div class="loading-line">Error loading repo.</div>`;
  }
}

function renderApps(apps) {
  if (!apps || apps.length === 0) {
    appsArea.innerHTML = `<div class="loading-line">No apps found.</div>`;
    return;
  }
  appsArea.innerHTML = "";
  apps.forEach(app => {
    const latest = (app.versions && app.versions.length) ? app.versions[0] : {};
    const version = latest.version || app.version || "";
    const desc = app.subtitle || app.localizedDescription || latest.localizedDescription || "";
    const downloadURL = app.downloadURL || latest.downloadURL || "#";
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="icon"><img src="${app.iconURL || ""}" alt=""></div>
      <div class="title">${app.name || ""}</div>
      <div class="subtitle">${desc}</div>
      <div class="version">${version ? "Version " + version : ""}</div>
      <a class="download" href="${downloadURL}" target="_blank" rel="noopener">Download</a>
    `;
    appsArea.appendChild(card);
  });
}

backBtn.addEventListener("click", () => {
  viewingRepoUrl = null;
  appsArea.innerHTML = "";
  reposArea.style.display = "";
  importRepoBox.style.display = "";
  backBtn.style.display = "none";
  searchBar.style.display = "none";
  window.scrollTo({ top: 0, behavior: "auto" });
});

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  const filtered = (currentApps || []).filter(app => {
    const latest = (app.versions && app.versions.length) ? app.versions[0] : {};
    const fields = [
      app.name, app.subtitle, app.localizedDescription,
      app.developerName, app.bundleIdentifier, latest.localizedDescription
    ];
    return fields.some(f => f && f.toLowerCase().includes(q));
  });
  renderApps(filtered);
});

// =======================================================
// ADDED: USER REPO IMPORT SUPPORT
// =======================================================
importBtn.addEventListener("click", async () => {
  const url = importInput.value.trim();
  if (!url) return showToast("Enter a repo URL");

  try {
    const res = await fetch("/api/import", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url })
    });

    const data = await res.json();
    if (!res.ok) return showToast(data.error || "Import failed");

    showToast("Repo added!");
    importInput.value = "";
    loadRepos();
  } catch (e) {
    console.error(e);
    showToast("Import failed");
  }
});

// =======================================================
loadRepos();
</script>
</body>
</html>
